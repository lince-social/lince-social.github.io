name: Send Countdown Email

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 1-7 * 1" # 03:00 UTC = 00:00 Brazil (UTC-3)

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Create campaign
        run: |
          RESPONSE=$(curl -s -X POST \
            https://${{ secrets.MAILCHIMP_SERVER_PREFIX }}.api.mailchimp.com/3.0/campaigns \
            -u "any:${{ secrets.MAILCHIMP_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "type":"regular",
              "recipients":{"list_id":"'"${{ secrets.MAILCHIMP_AUDIENCE_ID }}"'"},
              "settings":{
                "subject_line":"panorama_amanha",
                "from_name":"panorama_amanha",
                "reply_to":"xaviduds@gmail.com"
              }
            }')

          echo "$RESPONSE"

          CAMPAIGN_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$CAMPAIGN_ID" = "null" ] || [ -z "$CAMPAIGN_ID" ]; then
            echo "Failed to create campaign"
            exit 1
          fi

          echo "CAMPAIGN_ID=$CAMPAIGN_ID" >> $GITHUB_ENV

      - name: Set content
        run: |
          curl -s -X PUT \
            https://${{ secrets.MAILCHIMP_SERVER_PREFIX }}.api.mailchimp.com/3.0/campaigns/${{ env.CAMPAIGN_ID }}/content \
            -u "any:${{ secrets.MAILCHIMP_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "html":"<body style=\"margin:0;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Arial;\"><div style=\"font-size:32px;\">Panorama amanh√£</div><div style=\"margin-top:40px;font-size:12px;text-align:center;\"><a href=\"*|UNSUB|*\" style=\"color:#fff;\">unsubscribe</a><br>*|LIST:ADDRESS|*</div></body>"
            }'

      - name: Send campaign
        run: |
          curl -s -X POST \
            https://${{ secrets.MAILCHIMP_SERVER_PREFIX }}.api.mailchimp.com/3.0/campaigns/${{ env.CAMPAIGN_ID }}/actions/send \
            -u "any:${{ secrets.MAILCHIMP_API_KEY }}"
